sgrep() {
  grep "$@" | grep -v .svn
}

up() {
  local x='';
  for i in $(seq ${1:-1});
    do x="$x../";
  done;
  cd $x;
}

diff_brief() {
  /usr/bin/diff --brief -r "$1" "$2" | sed 's/^Files /diff /' | sed 's/ and / /' | sed 's/ differ$//'
}

diff_eversions() {
  echo diff holly consign
  diff <(ssh holly.pcbi.upenn.edu eversions) <(ssh consign eversions)
  echo diff zcluster consign
  diff <(ssh zcluster.rcc.uga.edu eversions) <(ssh consign eversions)
}


qapwd() { 
    if [[ -z "$1" ]]; then echo 'usage: qapwd trichqa';  return; fi
    ldapsearch -LLL -x -H ldaps://ds3.apidb.org \
      -D "uid=mheiges,ou=People,dc=apidb,dc=org" -W \
      -b "uid=$1,ou=People,dc=apidb,dc=org" \
      -s base \
      userPassword \
      | perl -p0e 's/\n //g' \
      | grep userPassword \
      | sed 's/userPassword:: //' \
      | openssl base64 -d \
      | sed 's/{CLEAR}//' 
}

diff_ldap_tns() {
  echo diff ds1 ds4
  diff <(ldapsearch -LLL -x -H ldaps://ds1.apidb.org -b "cn=OracleContext,ou=applications,dc=apidb,dc=org" -S cn 'orclNetDescString' 'cn' | perl -p0e 's/\n //g') <(ldapsearch -LLL -x -H ldaps://ds1.apidb.org -b "cn=OracleContext,ou=applications,dc=apidb,dc=org" -S cn 'orclNetDescString' 'cn' | perl -p0e 's/\n //g')
}

diff_ldap_people() {
  if [[ -z "$1" ]]; then echo 'usage: diff_ldap_people password';  return; fi
  pw=$1
  echo diff ds1 ds4
  diff <(ldapsearch  -LLL -x -H ldaps://ds1.apidb.org -D "uid=mheiges,ou=People,dc=apidb,dc=org" -w $pw -b 'ou=People,dc=apidb,dc=org' -S cn 'cn' 'userPassword' 'mail') <(ldapsearch  -LLL -x -H ldaps://ds4.apidb.org -D "uid=mheiges,ou=People,dc=apidb,dc=org" -w $pw -b 'ou=People,dc=apidb,dc=org' -S cn 'cn' 'userPassword' 'mail')
}

diff_ldap_orclsrv() {
  echo diff ds1 ds4
  diff <(ldapsearch -LLL -x -H ldaps://ds1.apidb.org -b "cn=OracleLsnrctlServices,ou=applications,dc=apidb,dc=org" -S cn 'orclNetServiceName' 'cn' | perl -p0e 's/\n //g') <(ldapsearch -LLL -x -H ldaps://ds1.apidb.org -b "cn=OracleLsnrctlServices,ou=applications,dc=apidb,dc=org" -S cn 'orclNetServiceName' 'cn' | perl -p0e 's/\n //g')
}

lastsession() { 
  if [[ -z "$1" ]]; then echo 'usage: lastsession password instancename';  return; fi
  if [[ -z "$2" ]]; then echo 'usage: lastsession password instancename';  return; fi
  pw=$1
  instance=$2
  sqlplus -S system/$pw@$instance < \
    <(echo "select username,  \
            to_char(sysdate - last_call_et / 86400,'YYYY-MM-DD HH24:MI') \
            from v\$session where username is not null \
            and username not in ('DBSNMP', 'SYSTEM');")
}

# manage dot files;
# based on https://news.ycombinator.com/item?id=11071754
dotf() {
  git --git-dir=$HOME/.dotfiles.git/ --work-tree=$HOME "$@"
}

check_uncommitted_dotfiles() {
  mod_dotfiles="$(dotf ls-files -m)"
  if [[ -n $mod_dotfiles ]]; then
    echo -e " \x1B[1mYou have uncommitted dot files.\x1B[0m Run"
    echo -n "dotf commit"
    for i in $mod_dotfiles; do
      echo -n " $i"
    done
    echo
  fi
}

check_unpushed_dotfiles() {
  mod_dotfiles="$(dotf diff HEAD origin/master --name-only)"
  if [[ -n $mod_dotfiles ]]; then
    echo -e " \x1B[1mYou have locally committed dot files not yet pushed.\x1B[0m Run"
    echo "dotf push"
  fi
}

check_unmerged_dotfiles() {
  dotf fetch
  dotf checkout | sed 's/Your branch is/Your dotfiles are/' | sed 's/git/dotf/'
}

# print file without #-delimited comments
decomment() {
  grep -v '^\W*#' $1 | egrep -v '^\W*$'
}

ot() {
  open -a Terminal "`pwd`"
}


function nginxerrbyip () {
  # grep Nginx logs for errors for given IP address, optional
  # date timestamp
  IP=$1
  DATE=$2
  find /var/log/nginx/ -maxdepth 2 -name access_log 2> >(grep -v 'Permission denied' >&2) | \
    xargs ack ${IP} | \
    egrep ' 500 | 404 ' | \
    grep "${DATE}"
}

function nginxbyip () {
  # grep Nginx logs for given IP address, optional
  # date timestamp
  IP=$1
  DATE=$2
  find /var/log/nginx/ -maxdepth 2 -name access_log 2> >(grep -v 'Permission denied' >&2) | \
    xargs ack ${IP} | \
    grep "${DATE}"
}

